<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Space Engineers: Sources/Sandbox.Game/Game/Entities/Character/MyInverseKinematics.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Space Engineers
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_937900b87e0c7a5fa01190c395fb83f7.html">Sources</a></li><li class="navelem"><a class="el" href="dir_adcb7f0194fb5944415bcd7197787778.html">Sandbox.Game</a></li><li class="navelem"><a class="el" href="dir_04f95e6316a1b10de98d9c990257507d.html">Game</a></li><li class="navelem"><a class="el" href="dir_32f85bfbb9683a43b39343881782b5b3.html">Entities</a></li><li class="navelem"><a class="el" href="dir_4f47232dc91e155a6b1a5327da118929.html">Character</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MyInverseKinematics.cs</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_my_inverse_kinematics_8cs.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> <a class="code" href="_my_gui_skin_definition_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a>;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.<a class="code" href="namespace_system_1_1_collections.html">Collections</a>.<a class="code" href="namespace_system_1_1_collections_1_1_generic.html">Generic</a>;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.<a class="code" href="namespace_system_1_1_linq.html">Linq</a>;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.<a class="code" href="namespace_system_1_1_text.html">Text</a>;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_v_rage_math.html">VRageMath</a>;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_sandbox.html">Sandbox</a>.<a class="code" href="namespace_sandbox_1_1_game.html">Game</a>.<a class="code" href="namespace_sandbox_1_1_game_1_1_entities.html">Entities</a>.<a class="code" href="namespace_sandbox_1_1_game_1_1_entities_1_1_character.html">Character</a>;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_sandbox.html">Sandbox</a>.<a class="code" href="namespace_sandbox_1_1_engine.html">Engine</a>.<a class="code" href="namespace_sandbox_1_1_engine_1_1_utils.html">Utils</a>;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_havok.html">Havok</a>;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_sandbox.html">Sandbox</a>.<a class="code" href="namespace_sandbox_1_1_engine.html">Engine</a>.<a class="code" href="namespace_sandbox_1_1_engine_1_1_physics.html">Physics</a>;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="namespace_v_rage_render_1_1_animations.html">Animations</a>;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_v_rage.html">VRage</a>.<a class="code" href="namespace_v_rage_1_1_game.html">Game</a>.<a class="code" href="namespace_v_rage_1_1_game_1_1_entity.html">Entity</a>;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_v_rage.html">VRage</a>.<a class="code" href="namespace_v_rage_1_1_utils.html">Utils</a>;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_sandbox.html">Sandbox</a>.<a class="code" href="namespace_v_rage_1_1_game.html#ae840d3864e36153d6f5013c7a0403dcf">Game</a>.<a class="code" href="namespace_entities.html">Entities</a>.<a class="code" href="namespace_sandbox_1_1_game_1_1_entities.html#ab6e850d9cf3c042efac58575b1459daba76a40e4f974fd895a0a2598c1cee28b4">Character</a></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;{</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    [Obsolete]</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class </span>MyInverseKinematics</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    {</div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html">   23</a></span>&#160;        <span class="keyword">public</span> <span class="keyword">struct </span><a class="code" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html">CastHit</a></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        {</div>
<div class="line"><a name="l00025"></a><span class="lineno"><a class="line" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a060625392d2503cb24dfb5d31930c8da">   25</a></span>&#160;            <span class="keyword">public</span> <a class="code" href="namespace_vector3.html">Vector3</a> <a class="code" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a060625392d2503cb24dfb5d31930c8da">Position</a>; <span class="comment">// position of the hit</span></div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a12c58e10f64b6a66ba7a1a62e15045bf">   26</a></span>&#160;            <span class="keyword">public</span> <a class="code" href="namespace_vector3.html">Vector3</a> <a class="code" href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a12c58e10f64b6a66ba7a1a62e15045bf">Normal</a>;   <span class="comment">// normal at the hit</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        }</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> SolveCCDIk(ref <a class="code" href="namespace_vector3.html">Vector3</a> desiredEnd, List&lt;MyCharacterBone&gt; bones, <span class="keywordtype">float</span> stopDistance, <span class="keywordtype">int</span> maxTries, <span class="keywordtype">float</span> gain, ref <a class="code" href="namespace_matrix.html">Matrix</a> finalTransform, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> finalBone = null, <span class="keywordtype">bool</span> allowFinalBoneTranslation = <span class="keyword">true</span>)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        {</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;            <a class="code" href="namespace_vector3_d.html">Vector3D</a> rootPos, curEnd, targetVector, curVector, crossResult;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;            <span class="keywordtype">double</span> cosAngle, turnAngle;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;            <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> endBone = bones.Last();</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;            <span class="keywordtype">int</span> tries = 0;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;            curEnd = <a class="code" href="namespace_vector3.html">Vector3</a>.Zero;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;            <span class="keywordflow">do</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;            {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                <span class="keywordflow">foreach</span> (<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> bone <span class="keywordflow">in</span> bones.Reverse&lt;<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a>&gt;())</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                {</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                    <span class="comment">// first recalculate current final transformation</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                    endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                    <span class="comment">// compute the position of the root</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                    <a class="code" href="namespace_matrix.html">Matrix</a> currentMatrix = bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                    rootPos = (<a class="code" href="_my_camera_8cs.html#afeb956ae9f85b0c1c7f8d5ce4a07b8e5">Vector3D</a>)currentMatrix.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>;  <span class="comment">// this is this bone root position</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;                    curEnd = (<a class="code" href="namespace_vector3_d.html">Vector3D</a>)endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>;   <span class="comment">// this is our current end of the final bone                  </span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;                    <span class="comment">// get the difference from desired and and current final position</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;                    <span class="keywordtype">double</span> distance = <a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                    <span class="comment">// see if i&#39;m already close enough</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                    <span class="keywordflow">if</span> (distance &gt; stopDistance)</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                    {</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                        <span class="comment">// create the vector to the current effector posm this is the difference vector</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                        curVector = curEnd - rootPos;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;                        <span class="comment">// create the desired effector position vector</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                        targetVector = desiredEnd - rootPos;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                        <span class="comment">// normalize the vectors (expensive, requires a sqrt)</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                        curVector.<a class="code" href="struct_v_rage_math_1_1_vector3_d.html#a3b0d757665dc587b630b4cc982e25f2b">Normalize</a>();</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                        targetVector.<a class="code" href="struct_v_rage_math_1_1_vector3_d.html#a3b0d757665dc587b630b4cc982e25f2b">Normalize</a>();</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                        <span class="comment">// the dot product gives me the cosine of the desired angle</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                        cosAngle = curVector.<a class="code" href="struct_v_rage_math_1_1_vector3_d.html#aef09c09066721606efaca69aabbfeeb8">Dot</a>(targetVector);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                        <span class="comment">// if the dot product returns 1.0, i don&#39;t need to rotate as it is 0 degrees</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                        <span class="keywordflow">if</span> (cosAngle &lt; 1.0)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                        {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                            <span class="comment">// use the cross product to check which way to rotate</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                            crossResult = curVector.<a class="code" href="struct_v_rage_math_1_1_vector3_d.html#a3bcd8fcad5040b7e34f1ef56d5aa7f56">Cross</a>(targetVector);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                            crossResult.<a class="code" href="struct_v_rage_math_1_1_vector3_d.html#a3b0d757665dc587b630b4cc982e25f2b">Normalize</a>();</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                            turnAngle = <a class="code" href="namespace_system.html">System</a>.Math.Acos(cosAngle); <span class="comment">// get the angle</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                            <span class="comment">// get the matrix needed to rotate to the desired position</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                            <a class="code" href="namespace_matrix.html">Matrix</a> rotation = <a class="code" href="namespace_matrix.html">Matrix</a>.CreateFromAxisAngle((<a class="code" href="namespace_vector3.html">Vector3</a>)crossResult, (<span class="keywordtype">float</span>)turnAngle * gain);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                            <span class="comment">// get the absolute matrix rotation ie - rotation including all the bones before</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                            <a class="code" href="namespace_matrix.html">Matrix</a> absoluteTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Normalize(currentMatrix).GetOrientation() * rotation;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                            <span class="comment">// compute just the local matrix for the bone - need to multiply with inversion ot its parent matrix and original bind transform      </span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                            <a class="code" href="namespace_matrix.html">Matrix</a> parentMatrix = <a class="code" href="namespace_matrix.html">Matrix</a>.Identity;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                            <span class="keywordflow">if</span> (bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a> != null) parentMatrix = bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a>.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                            parentMatrix = <a class="code" href="namespace_matrix.html">Matrix</a>.Normalize(parentMatrix); <span class="comment">// may have different scale</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                            <a class="code" href="namespace_matrix.html">Matrix</a> localTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Multiply(absoluteTransform, <a class="code" href="namespace_matrix.html">Matrix</a>.Invert(bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ac54d9a735e8deaaed35b97f96ef7f405">BindTransform</a> * parentMatrix));</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                            <span class="comment">// now change the current matrix rotation                           </span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                            bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a94364706606a4cd5d7c3d67a4ce4b296">Rotation</a> = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(localTransform);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                            <span class="comment">// and recompute the transformation</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                            bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                        }</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                    }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                }</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="comment">// quit if i am close enough or been running long enough</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            } <span class="keywordflow">while</span> (tries++ &lt; maxTries &amp;&amp;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                <a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd) &gt; stopDistance);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="comment">// solve the last bone</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">if</span> (finalBone != null &amp;&amp; finalTransform.IsValid())</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                <span class="comment">//MatrixD absoluteTransformEnd = finalBone.AbsoluteTransform * finalTransform; // this is our local final transform ( rotation)</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                <span class="comment">// get the related transformation to original binding posefirstBoneAbsoluteTransform</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                <a class="code" href="namespace_matrix_d.html">MatrixD</a> localTransformRelated;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) localTransformRelated = finalTransform * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                <span class="keywordflow">else</span> localTransformRelated = finalTransform.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>() * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                <span class="comment">//localTransformRelated = Matrix.Normalize(localTransformRelated);</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="comment">// from there get the rotation and translation</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                finalBone.Rotation = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(<a class="code" href="namespace_matrix.html">Matrix</a>.Normalize((<a class="code" href="namespace_matrix.html">Matrix</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>()));</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) finalBone.Translation = (<a class="code" href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">Translation</a>;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                finalBone.ComputeAbsoluteTransform();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd) &lt;= stopDistance;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        }</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;       </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> SolveTwoJointsIk(ref <a class="code" href="namespace_vector3.html">Vector3</a> desiredEnd, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> firstBone, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> secondBone, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> endBone, ref <a class="code" href="namespace_matrix.html">Matrix</a> finalTransform, <a class="code" href="namespace_matrix.html">Matrix</a> WorldMatrix, <a class="code" href="namespace_vector3.html">Vector3</a> normal, <span class="keywordtype">bool</span> preferPositiveAngle = <span class="keyword">true</span>, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> finalBone = null, <span class="keywordtype">bool</span> allowFinalBoneTranslation = <span class="keyword">true</span>, <span class="keywordtype">bool</span> minimizeRotation = <span class="keyword">true</span>)</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="comment">//TODO: Implement this new method, that will consider signed/unsigned angles of bone configurations for analytic solution and use a passed normal parameter for proper rotations configuration</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;             <span class="keywordflow">throw</span> <span class="keyword">new</span> NotImplementedException();</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            <span class="comment">//Matrix firstBoneAbsoluteTransform = firstBone.AbsoluteTransform;</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <span class="comment">//Matrix secondBoneAbsoluteTransform = secondBone.AbsoluteTransform;</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;            <span class="comment">//Matrix endBoneAbsoluteTransform = endBone.AbsoluteTransform;</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            <span class="comment">//Vector3 origin = firstBoneAbsoluteTransform.Translation;</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            <span class="comment">//Vector3 originToCurrentEnd = endBoneAbsoluteTransform.Translation - origin;</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;            <span class="comment">//Vector3 originToDesiredEnd = desiredEnd - origin;</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            <span class="comment">//Vector3 firstBoneVector = secondBoneAbsoluteTransform.Translation - origin;</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            <span class="comment">//Vector3 secondBoneVector = originToCurrentEnd - firstBoneVector;</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <span class="comment">//float firstBoneLength = firstBoneVector.Length();</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            <span class="comment">//float secondBoneLength = secondBoneVector.Length();</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="comment">//float originToDesiredEndLength = originToDesiredEnd.Length();</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="comment">//float originToCurrentEndLength = originToCurrentEnd.Length();</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <span class="comment">//if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_IKSOLVERS)</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawSphere(Vector3.Transform(desiredEnd, WorldMatrix), 0.01f, Color.Red, 1, false);</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin, WorldMatrix), Vector3.Transform(origin + originToCurrentEnd, WorldMatrix), Color.Yellow, Color.Yellow, false);</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin, WorldMatrix), Vector3.Transform(origin + originToDesiredEnd, WorldMatrix), Color.Red, Color.Red, false);</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin, WorldMatrix), Vector3.Transform(origin + firstBoneVector, WorldMatrix), Color.Green, Color.Green, false);</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin + firstBoneVector, WorldMatrix), Vector3.Transform(origin + firstBoneVector + secondBoneVector, WorldMatrix), Color.Blue, Color.Blue, false);</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="comment">// only two cases, the desired position is reachable or not</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="comment">//bool isDesiredEndReachable = firstBoneLength + secondBoneLength &gt; originToDesiredEndLength;</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="comment">// alpha = angle between the first bone and originToDesiredEnd vector</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            <span class="comment">//double finalAlpha = 0;</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;            <span class="comment">// beta = the angle between the first and second bone</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <span class="comment">//double finalBeta = 0;</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            <span class="comment">//if (isDesiredEndReachable)</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            <span class="comment">//    CosineLaw(firstBoneLength, secondBoneLength, originToDesiredEndLength, out finalAlpha, out finalBeta);</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            <span class="comment">//}                   </span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            <span class="comment">// get the current angles between bones</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            <span class="comment">//Vector3 planeNormal = Vector3.Cross(originToCurrentEnd, firstBoneVector);</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="comment">//planeNormal.Normalize();</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="comment">//double currentAlpha = GetAngleSigned(originToCurrentEnd, firstBoneVector, planeNormal);</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="comment">//double delta = GetAngleSigned(originToCurrentEnd, originToDesiredEnd, planeNormal);</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="comment">//finalAlpha = 1f;</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <span class="comment">//planeNormal.X = 0.94f; planeNormal.Y = 0.27f; planeNormal.Z = -0.18f;</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="comment">//RotateBone(firstBone, planeNormal, delta);</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            <span class="comment">//if (delta &lt; 0)</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            <span class="comment">//    finalAlpha = -finalAlpha;</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            <span class="comment">//if (finalAlpha.IsValid()) RotateBone(firstBone, planeNormal, finalAlpha);</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            </div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="comment">//currentBeta = Math.PI - currentBeta;</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="comment">//Vector3 crossProduct = Vector3.Cross(firstBoneVector, originToCurrentEnd);</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment"></span>            <span class="comment">//float sinThetaX = crossProduct.X / (firstBoneVector.Length() * originToCurrentEnd.Length()) * Vector3.Normalize(crossProduct).X;</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="comment">//float sinThetaY = crossProduct.Y / (firstBoneVector.Length() * originToCurrentEnd.Length()) * Vector3.Normalize(crossProduct).Y;</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <span class="comment">//float sinThetaZ = crossProduct.Z / (firstBoneVector.Length() * originToCurrentEnd.Length()) * Vector3.Normalize(crossProduct).Z;</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            <span class="comment">//double theta = 0;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            <span class="comment">//if (crossProduct.X != 0)</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            <span class="comment">//    theta = Math.Asin(sinThetaX);</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            <span class="comment">//else if (crossProduct.Y != 0)</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            <span class="comment">//    theta = Math.Asin(sinThetaY);</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="comment">//else</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            <span class="comment">//    theta = Math.Asin(sinThetaZ);</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            <span class="comment">//if (currentAlpha != theta)</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <span class="comment">//    currentAlpha = -currentAlpha;</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <span class="comment">//    currentBeta = -currentBeta;</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;            <span class="comment">// get the angle between original and final position plane normal</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;            <span class="comment">//originToCurrentEnd.Normalize();</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <span class="comment">//originToDesiredEnd.Normalize();</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            <span class="comment">//double dotProd = Vector3.Dot(Vector3.Normalize();</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            <span class="comment">//dotProd = MathHelper.Clamp(dotProd, -1, 1);</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            <span class="comment">//double delta = Math.Acos(dotProd);</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="comment">// set the alpha to positive/negative so the total rotation is minimized</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            <span class="comment">//if (currentAlpha + delta + finalAlpha &gt; currentAlpha + delta - finalAlpha)</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="comment">//    finalAlpha = -finalAlpha;</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;            <span class="comment">//    finalBeta = -finalBeta;</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            <span class="comment">//else</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            <span class="comment">//    //finalBeta = Math.PI-finalBeta;</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <span class="comment">//Vector3 currentPlaneNormal = Vector3.Cross(firstBoneVector, originToCurrentEnd);</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="comment">//currentPlaneNormal.Normalize();</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="comment">// we can now rotate the bones in current plane as if the desired end was on the currentEnd axis</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="comment">//float alphaDif = (float)(finalAlpha - currentAlpha);</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            <span class="comment">//float betaDif = (float)(finalBeta - currentBeta);</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            <span class="comment">//Matrix firstBoneRotation = Matrix.CreateFromAxisAngle(currentPlaneNormal, alphaDif);</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="comment">//Matrix secondBoneRotation = Matrix.CreateFromAxisAngle(currentPlaneNormal, betaDif);</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            <span class="comment">//Matrix firstBoneFinalTransform = firstBoneAbsoluteTransform * firstBoneRotation;</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;            <span class="comment">//Matrix firstBoneParentAbsoluteTransform = firstBone.Parent.AbsoluteTransform;</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="comment">//Matrix localFirstBoneTransform = Matrix.Multiply(firstBoneFinalTransform, Matrix.Invert(firstBone.BindTransform * firstBoneParentAbsoluteTransform));</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            <span class="comment">//firstBone.Rotation = Quaternion.CreateFromRotationMatrix(localFirstBoneTransform);</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="comment">//firstBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            <span class="comment">//Matrix secondBoneFinalTransform = secondBoneAbsoluteTransform * secondBoneRotation;</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            <span class="comment">//Matrix secondBoneParentAbsoluteTransform = secondBone.Parent.AbsoluteTransform;</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="comment">//Matrix localSecondBoneTransform = Matrix.Multiply(secondBoneFinalTransform, Matrix.Invert(secondBone.BindTransform * secondBoneParentAbsoluteTransform));</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <span class="comment">//secondBone.Rotation = Quaternion.CreateFromRotationMatrix(localSecondBoneTransform);</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="comment">//secondBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="comment">//if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_IKSOLVERS)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            <span class="comment">//    Vector3 rotatedFirst = Vector3.Transform(firstBoneVector, firstBoneRotation);</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;            <span class="comment">//    Vector3 rotatedSecond = Vector3.Transform(secondBoneVector, secondBoneRotation);</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin, WorldMatrix), Vector3.Transform(origin + rotatedFirst, WorldMatrix), Color.Purple, Color.Purple, false);</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(Vector3.Transform(origin + rotatedFirst, WorldMatrix), Vector3.Transform(origin + rotatedFirst + rotatedSecond, WorldMatrix), Color.White, Color.White, false);</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            <span class="comment">// Now we compute the final absolute transforms for the bones</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <span class="comment">//Matrix firstBoneFinalAbsoluteTransform = firstBoneAbsoluteTransform * firstBoneRotation;</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            <span class="comment">//Matrix firstBoneParentAbsoluteTransform = firstBone.Parent.AbsoluteTransform;</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            <span class="comment">//Matrix localFirstBoneTransform = Matrix.Multiply(firstBoneFinalAbsoluteTransform, Matrix.Invert(firstBone.BindTransform * firstBoneParentAbsoluteTransform));</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            <span class="comment">//firstBone.Rotation = Quaternion.CreateFromRotationMatrix(localFirstBoneTransform);</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            <span class="comment">//firstBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="comment">//Matrix secondBoneFinalAbsoluteTransform = secondBoneAbsoluteTransform * secondBoneRotation;</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            <span class="comment">//Matrix secondBoneParentAbsoluteTransform = secondBone.Parent.AbsoluteTransform;</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            <span class="comment">//Matrix localSecondBoneTransform = Matrix.Multiply(secondBoneFinalAbsoluteTransform, Matrix.Invert(secondBone.BindTransform * secondBoneParentAbsoluteTransform));</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;            <span class="comment">//secondBone.Rotation = Quaternion.CreateFromRotationMatrix(localSecondBoneTransform);</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            <span class="comment">//secondBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            <span class="comment">// minimize the rotation of the second joint from it&#39;s origin</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <span class="comment">// this will mean to rotate around originToDesiredEnd vector</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            <span class="comment">//if (minimizeRotation &amp;&amp; isDesiredEndReachable)</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            <span class="comment">//    Vector3 a = originToDesiredEnd;</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            <span class="comment">//    Vector3 v = secondBone.AbsoluteTransform.Translation - firstBone.AbsoluteTransform.Translation;</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="comment">//    Vector3 k = firstBoneVector;</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            <span class="comment">//    a.Normalize();</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="comment">//    v.Normalize();</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="comment">//    k.Normalize();</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="comment">//    float A = Vector3.Dot(a, v) * Vector3.Dot(a, k) - Vector3.Dot(Vector3.Cross(Vector3.Cross(a, v), a), k);</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            <span class="comment">//    float B = Vector3.Dot(Vector3.Cross(a, v), k);</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            <span class="comment">//    float C = Vector3.Dot(v, k);</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            <span class="comment">//    double theta1 = Math.Atan(2 * B / (C - A));</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            <span class="comment">//    double theta2 = Math.PI + theta1;</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            <span class="comment">//    double finalTheta = 0;</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <span class="comment">//    double secondDerivate1 = (A - C) / 2 * Math.Cos(theta1) - B * Math.Sin(theta1);</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="comment">//    if (secondDerivate1 &gt; 0)</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            <span class="comment">//        finalTheta = theta2;</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="comment">//    else</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            <span class="comment">//        finalTheta = theta1;</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            <span class="comment">//    Matrix minimizingMatrix = Matrix.CreateFromAxisAngle(a, (float)finalTheta);</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <span class="comment">//    Matrix firstBoneFinalMinimizedTransform = firstBone.AbsoluteTransform * minimizingMatrix;</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            <span class="comment">//    firstBoneParentAbsoluteTransform = firstBone.Parent.AbsoluteTransform;</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <span class="comment">//    localFirstBoneTransform = Matrix.Multiply(firstBoneFinalMinimizedTransform, Matrix.Invert(firstBone.BindTransform * firstBoneParentAbsoluteTransform));</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="comment">//    firstBone.Rotation = Quaternion.CreateFromRotationMatrix(localFirstBoneTransform);</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            <span class="comment">//    firstBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="comment">// solve the last bone </span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            <span class="comment">//if (finalBone != null &amp;&amp; finalTransform.IsValid() &amp;&amp; isDesiredEndReachable)</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            <span class="comment">//    //MatrixD absoluteTransformEnd = finalBone.AbsoluteTransform * finalTransform; // this is our local final transform ( rotation)</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            <span class="comment">//    // get the related transformation to original binding pose</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            <span class="comment">//    MatrixD localTransformRelated;</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            <span class="comment">//    if (allowFinalBoneTranslation) localTransformRelated = finalTransform * MatrixD.Invert((MatrixD)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            <span class="comment">//    else localTransformRelated = finalTransform.GetOrientation() * MatrixD.Invert((MatrixD)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="comment">//    //localTransformRelated = Matrix.Normalize(localTransformRelated);</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            <span class="comment">//    // from there get the rotation and translation</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <span class="comment">//    finalBone.Rotation = Quaternion.CreateFromRotationMatrix(Matrix.Normalize((Matrix)localTransformRelated.GetOrientation()));</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="comment">//    if (allowFinalBoneTranslation) finalBone.Translation = (Vector3)localTransformRelated.Translation;</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            <span class="comment">//    finalBone.ComputeAbsoluteTransform();</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;             <span class="comment">//    //return isDesiredEndReachable;            </span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> SolveTwoJointsIkCCD(<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a>[] characterBones, <span class="keywordtype">int</span> firstBoneIndex, <span class="keywordtype">int</span> secondBoneIndex, <span class="keywordtype">int</span> endBoneIndex, </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            ref <a class="code" href="namespace_matrix.html">Matrix</a> finalTransform, ref <a class="code" href="namespace_matrix_d.html">MatrixD</a> worldMatrix, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> finalBone = null, <span class="keywordtype">bool</span> allowFinalBoneTranslation = <span class="keyword">true</span>)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            <span class="keywordflow">if</span> (finalBone == null)</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> desiredEnd = finalTransform.Translation;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            <span class="comment">//VRageRender.MyRenderProxy.DebugDrawSphere(Vector3D.Transform(desiredEnd, worldMatrix), 0.015f, Color.LightGoldenrodYellow, 1, false);</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> rootPos, curEnd;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> curVector;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <span class="keywordtype">double</span> cosAngle, turnAngle;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            <span class="keywordtype">int</span> tries = 0;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            <span class="keywordtype">int</span> maxTries = 50;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            <span class="keywordtype">float</span> stopDistanceSq = 0.005f * 0.005f;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            <span class="keywordtype">float</span> gain = 0.65f;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> firstBone = characterBones[firstBoneIndex];</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> secondBone = characterBones[secondBoneIndex];</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> endBone = characterBones[endBoneIndex];</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                </div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            <span class="comment">//unsafe</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                <span class="comment">//int* boneIndices = stackalloc int[3];</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                <span class="keywordtype">int</span>[] boneIndices = <span class="keyword">new</span> <span class="keywordtype">int</span>[3];</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                boneIndices[2] = firstBoneIndex;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                boneIndices[1] = secondBoneIndex;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                boneIndices[0] = endBoneIndex;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                curEnd = <a class="code" href="namespace_vector3.html">Vector3</a>.Zero;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; i++)</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                {</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    var bone = characterBones[boneIndices[i]];</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                    <a class="code" href="namespace_vector3.html">Vector3</a> tempTranslation = bone.BindTransform.Translation;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                    <a class="code" href="namespace_quaternion.html">Quaternion</a> tempRotation = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(bone.BindTransform);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                    bone.SetCompleteTransform(ref tempTranslation, ref tempRotation);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                    bone.ComputeAbsoluteTransform();</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                curEnd = endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                <span class="keywordtype">float</span> initialDistSqInv = 1 / (float)<a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                <span class="keywordflow">do</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; i++)</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                    {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                        var bone = characterBones[boneIndices[i]];</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                        <span class="comment">// first recalculate current final transformation</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                        endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                        <span class="comment">// compute the position of the root</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                        <a class="code" href="namespace_matrix.html">Matrix</a> currentMatrix = bone.AbsoluteTransform;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                        rootPos = currentMatrix.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>; <span class="comment">// this is this bone root position</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                        <a class="code" href="namespace_vector3.html">Vector3</a> lastEnd = curEnd;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                        curEnd = endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                            <span class="comment">// this is our current end of the final bone                  </span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                        <span class="comment">// get the difference from desired and and current final position</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                        <span class="keywordtype">double</span> distanceSq = <a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd);</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                        </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                        <span class="comment">//{</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                        <span class="comment">//    Color c = Color.FromNonPremultiplied(new Vector4(4 * (float) (distanceSq),</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                        <span class="comment">//        1 - 4 * (float) (distanceSq), 0, 1));</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                        <span class="comment">//    VRageRender.MyRenderProxy.DebugDrawLine3D(</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                        <span class="comment">//        Vector3D.Transform(lastEnd, worldMatrix),</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                        <span class="comment">//        Vector3D.Transform(curEnd, worldMatrix), c, c, false);</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                        <span class="comment">//}</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                        <span class="comment">// see if i&#39;m already close enough</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        <span class="keywordflow">if</span> (distanceSq &gt; stopDistanceSq)</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                        {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                            <span class="comment">// create the vector to the current effector posm this is the difference vector</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                            curVector = curEnd - rootPos;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                            <span class="comment">// create the desired effector position vector</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                            var targetVector = desiredEnd - rootPos;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                            <span class="comment">// normalize the vectors (expensive, requires a sqrt)</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                            <span class="comment">// MZ: we don&#39;t need to do that</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                            <span class="comment">// curVector.Normalize();</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                            <span class="comment">// targetVector.Normalize();</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                            <span class="keywordtype">double</span> curVectorLenSq = curVector.<a class="code" href="struct_v_rage_math_1_1_vector3.html#abe3f1b18fcf85173572d6f4ef7393060">LengthSquared</a>();</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                            <span class="keywordtype">double</span> targetVectorLenSq = targetVector.LengthSquared();</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                            <span class="comment">// the dot product gives me the cosine of the desired angle</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                            <span class="comment">// cosAngle = curVector.Dot(targetVector);</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                            <span class="keywordtype">double</span> dotCurTarget = curVector.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a5ce7a4adfe73e681da923ac25598b00d">Dot</a>(targetVector);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                            <span class="comment">// if the dot product returns 1.0, i don&#39;t need to rotate as it is 0 degrees</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                            <span class="comment">// MZ: yes, but when does this happen to be exactly 1???</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                            <span class="comment">// if (cosAngle &lt; 1.0)</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                            <span class="keywordflow">if</span> (dotCurTarget &lt; 0 || dotCurTarget * dotCurTarget &lt; curVectorLenSq * targetVectorLenSq * (1 - MyMathConstants.EPSILON))</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                            {</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                                <span class="comment">// use the cross product to check which way to rotate</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                                <span class="comment">//var rotationAxis = curVector.Cross(targetVector);</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                                <span class="comment">//rotationAxis.Normalize();</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                                <span class="comment">//turnAngle = System.Math.Acos(cosAngle); // get the angle</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                                <span class="comment">// get the matrix needed to rotate to the desired position</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                                <span class="comment">//Matrix rotation = Matrix.CreateFromAxisAngle((Vector3) rotationAxis,</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                                <span class="comment">//    (float) turnAngle * gain);</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                                <span class="comment">// get the absolute matrix rotation ie - rotation including all the bones before</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                                <a class="code" href="namespace_matrix.html">Matrix</a> rotation;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                                <span class="keywordtype">float</span> weight = 1 / (initialDistSqInv * (float)distanceSq + 1);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                                <a class="code" href="namespace_vector3.html">Vector3</a> weightedTarget = <a class="code" href="namespace_vector3.html">Vector3</a>.Lerp(curVector, targetVector, weight);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                                <a class="code" href="namespace_matrix.html">Matrix</a>.CreateRotationFromTwoVectors(ref curVector, ref weightedTarget, out rotation);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                                <a class="code" href="namespace_matrix.html">Matrix</a> absoluteTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Normalize(currentMatrix).GetOrientation() * rotation;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                                <span class="comment">// MZ: faster</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                                </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                                <span class="comment">// compute just the local matrix for the bone - need to multiply with inversion ot its parent matrix and original bind transform      </span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                                <a class="code" href="namespace_matrix.html">Matrix</a> parentMatrix = <a class="code" href="namespace_matrix.html">Matrix</a>.Identity;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                                <span class="keywordflow">if</span> (bone.Parent != null) parentMatrix = bone.Parent.AbsoluteTransform;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                                parentMatrix = <a class="code" href="namespace_matrix.html">Matrix</a>.Normalize(parentMatrix); <span class="comment">// may have different scale</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                                <a class="code" href="namespace_matrix.html">Matrix</a> localTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Multiply(absoluteTransform,</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                                    <a class="code" href="namespace_matrix.html">Matrix</a>.Invert(bone.BindTransform * parentMatrix));</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                                <span class="comment">// now change the current matrix rotation                           </span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                                bone.Rotation = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(localTransform);</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                                <span class="comment">// and recompute the transformation</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                                bone.ComputeAbsoluteTransform();</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                            }</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                        }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                    }</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                    <span class="comment">// quit if i am close enough or been running long enough</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                } <span class="keywordflow">while</span> (tries++ &lt; maxTries &amp;&amp;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                         <a class="code" href="namespace_vector3_d.html">Vector3D</a>.DistanceSquared(curEnd, desiredEnd) &gt; stopDistanceSq);</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            }</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            <span class="comment">// solve the last bone</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            <span class="keywordflow">if</span> (finalTransform.IsValid())</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                <span class="comment">// get the related transformation to original binding posefirstBoneAbsoluteTransform</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                <a class="code" href="namespace_matrix_d.html">MatrixD</a> localTransformRelated;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) </div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                    localTransformRelated = finalTransform * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                    localTransformRelated = finalTransform.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>() * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                <span class="comment">// localTransformRelated = Matrix.Normalize(localTransformRelated);</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                <span class="comment">// from there get the rotation and translation</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                finalBone.Rotation = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(<a class="code" href="namespace_matrix.html">Matrix</a>.Normalize((<a class="code" href="namespace_matrix.html">Matrix</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>()));</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) </div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                    finalBone.Translation = (<a class="code" href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">Translation</a>;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                finalBone.ComputeAbsoluteTransform();</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;<span class="comment">//Vector3D.DistanceSquared(curEnd, desiredEnd) &lt;= stopDistanceSq;</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        }</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> RotateBone(<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> bone, <a class="code" href="namespace_vector3.html">Vector3</a> planeNormal, <span class="keywordtype">double</span> angle)</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        {</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> rotation = <a class="code" href="namespace_matrix.html">Matrix</a>.CreateFromAxisAngle(planeNormal, (<span class="keywordtype">float</span>)angle);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> finalMatrix = bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a> * rotation;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> parentTransform = bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a> != null ? bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a>.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a> : <a class="code" href="namespace_matrix.html">Matrix</a>.Identity;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> localTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Multiply(finalMatrix, <a class="code" href="namespace_matrix.html">Matrix</a>.Invert(bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ac54d9a735e8deaaed35b97f96ef7f405">BindTransform</a> * parentTransform));</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a94364706606a4cd5d7c3d67a4ce4b296">Rotation</a> = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(localTransform);</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            bone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();        </div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        }</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">double</span> GetAngle(<a class="code" href="namespace_vector3.html">Vector3</a> a,<a class="code" href="namespace_vector3.html">Vector3</a> b)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;            <span class="keywordtype">float</span> dotProduct = <a class="code" href="namespace_vector3.html">Vector3</a>.Dot(<a class="code" href="namespace_vector3.html">Vector3</a>.Normalize(a), <a class="code" href="namespace_vector3.html">Vector3</a>.Normalize(b));</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            dotProduct = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(dotProduct, -1, 1);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="namespace_math.html">Math</a>.Acos(dotProduct);</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        }</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">double</span> GetAngleSigned(<a class="code" href="namespace_vector3.html">Vector3</a> a, <a class="code" href="namespace_vector3.html">Vector3</a> b, <a class="code" href="namespace_vector3.html">Vector3</a> normal)</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        {</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            <span class="keywordtype">float</span> dotProduct = <a class="code" href="namespace_vector3.html">Vector3</a>.Dot(<a class="code" href="namespace_vector3.html">Vector3</a>.Normalize(a), <a class="code" href="namespace_vector3.html">Vector3</a>.Normalize(b));</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            dotProduct = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(dotProduct, -1, 1);</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            <span class="keywordtype">double</span> angle = <a class="code" href="namespace_math.html">Math</a>.Acos(dotProduct);            </div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="namespace_vector3.html">Vector3</a>.Dot(normal, <a class="code" href="namespace_vector3.html">Vector3</a>.Cross(a,b)) &lt; 0)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            {</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                angle = -angle;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            }</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            <span class="keywordflow">return</span> angle;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> CosineLaw(<span class="keywordtype">float</span> A, <span class="keywordtype">float</span> B, <span class="keywordtype">float</span> C, out <span class="keywordtype">double</span> alpha, out <span class="keywordtype">double</span> beta)</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        {</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                <span class="comment">// we find proper angles </span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                <span class="comment">// cosine law c^2 = a^2 + b^2 - 2*a*b*cos(gamma)</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                <span class="comment">// gamma = acos ( - (c^2 - a^2 - b^2) / (2*a*b) )</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                <span class="comment">// alpha = angle between the first bone and originToDesiredEnd vector</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                <span class="keywordtype">double</span> cosAlpha = -(B * B - A * A - C * C) /</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                    (2 * A * C);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                cosAlpha = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cosAlpha, -1, 1);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                alpha = <a class="code" href="namespace_math.html">Math</a>.Acos(cosAlpha);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                <span class="comment">// beta = the angle between the first and second bone</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                <span class="keywordtype">double</span> cosBeta = -(C * C - A * A - B * B) /</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                    (2 * A * B);</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                cosBeta = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cosBeta, -1, 1);</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                beta = <a class="code" href="namespace_math.html">Math</a>.Acos(cosBeta);                            </div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        }</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> SolveTwoJointsIk(ref <a class="code" href="namespace_vector3.html">Vector3</a> desiredEnd, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> firstBone, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> secondBone, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> endBone, ref <a class="code" href="namespace_matrix.html">Matrix</a> finalTransform, <a class="code" href="namespace_matrix.html">Matrix</a> WorldMatrix, <a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">MyCharacterBone</a> finalBone = null, <span class="keywordtype">bool</span> allowFinalBoneTranslation = <span class="keyword">true</span>)</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        {</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> firstBoneAbsoluteTransform = firstBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> secondBoneAbsoluteTransform = secondBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> endBoneAbsoluteTransform = endBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> origin = firstBoneAbsoluteTransform.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a>;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> originToCurrentEnd = endBoneAbsoluteTransform.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a> - origin;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> originToDesiredEnd = desiredEnd - origin;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> firstBoneVector = secondBoneAbsoluteTransform.<a class="code" href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">Translation</a> - origin;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> secondBoneVector = originToCurrentEnd - firstBoneVector;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            <span class="keywordtype">float</span> firstBoneLength = firstBoneVector.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a4d44c319212bffba8239f9b1e96f9730">Length</a>();</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            <span class="keywordtype">float</span> secondBoneLength = secondBoneVector.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a4d44c319212bffba8239f9b1e96f9730">Length</a>();</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            <span class="keywordtype">float</span> originToDesiredEndLength = originToDesiredEnd.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a4d44c319212bffba8239f9b1e96f9730">Length</a>();</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keywordtype">float</span> originToCurrentEndLength = originToCurrentEnd.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a4d44c319212bffba8239f9b1e96f9730">Length</a>();</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="keywordflow">if</span> (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_IKSOLVERS)</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            {</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawSphere(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(desiredEnd, WorldMatrix), 0.01f, <a class="code" href="namespace_color.html">Color</a>.Red, 1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + originToCurrentEnd, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.Yellow, <a class="code" href="namespace_color.html">Color</a>.Yellow, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + originToDesiredEnd, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.Red, <a class="code" href="namespace_color.html">Color</a>.Red, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + firstBoneVector, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.Green, <a class="code" href="namespace_color.html">Color</a>.Green, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + firstBoneVector, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + firstBoneVector + secondBoneVector, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.Blue, <a class="code" href="namespace_color.html">Color</a>.Blue, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            }</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;            <span class="comment">// only two cases, the desired position is reachable or not</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="keywordtype">bool</span> isDesiredEndReachable = firstBoneLength + secondBoneLength &gt; originToDesiredEndLength;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="comment">// alpha = angle between the first bone and originToDesiredEnd vector</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordtype">double</span> finalAlpha = 0;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="comment">// beta = the angle between the first and second bone</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            <span class="keywordtype">double</span> finalBeta = 0;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            <span class="keywordflow">if</span> (isDesiredEndReachable)</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            {   <span class="comment">// we find proper angles </span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                <span class="comment">// cosine law c^2 = a^2 + b^2 - 2*a*b*cos(gamma)</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <span class="comment">// gamma = acos ( - (c^2 - a^2 - b^2) / (2*a*b) )</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                <span class="comment">// alpha = angle between the first bone and originToDesiredEnd vector</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                <span class="keywordtype">double</span> cosAlpha = -(secondBoneLength * secondBoneLength - firstBoneLength * firstBoneLength - originToDesiredEndLength * originToDesiredEndLength) /</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                    (2 * firstBoneLength * originToDesiredEndLength);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                cosAlpha = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cosAlpha, -1, 1);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                finalAlpha = <a class="code" href="namespace_math.html">Math</a>.Acos(cosAlpha);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                <span class="comment">// beta = the angle between the first and second bone</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                <span class="keywordtype">double</span> cosBeta = -(originToDesiredEndLength * originToDesiredEndLength - firstBoneLength * firstBoneLength - secondBoneLength * secondBoneLength) /</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    (2 * firstBoneLength * secondBoneLength);</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                cosBeta = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cosBeta, -1, 1);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                finalBeta = <a class="code" href="namespace_math.html">Math</a>.Acos(cosBeta);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                <span class="comment">// now get it to the root bone axis no</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                finalBeta = <a class="code" href="namespace_math.html">Math</a>.PI - finalBeta;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;            }</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            <span class="comment">// get the current angles</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordtype">double</span> cCosAlpha = -(secondBoneLength * secondBoneLength - firstBoneLength * firstBoneLength - originToCurrentEndLength * originToCurrentEndLength) /</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                (2 * firstBoneLength * originToCurrentEndLength);</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            cCosAlpha = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cCosAlpha, -1, 1);</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="keywordtype">double</span> currentAlpha = <a class="code" href="namespace_math.html">Math</a>.Acos(cCosAlpha);</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            <span class="keywordtype">double</span> cCosBeta = -(originToCurrentEndLength * originToCurrentEndLength - firstBoneLength * firstBoneLength - secondBoneLength * secondBoneLength) /</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                (2 * firstBoneLength * secondBoneLength);</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            cCosBeta = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(cCosBeta, -1, 1);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordtype">double</span> currentBeta = <a class="code" href="namespace_math.html">Math</a>.Acos(cCosBeta);</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            currentBeta = <a class="code" href="namespace_math.html">Math</a>.PI - currentBeta;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> currentPlaneNormal = <a class="code" href="namespace_vector3.html">Vector3</a>.Cross(firstBoneVector, originToCurrentEnd);</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            currentPlaneNormal.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ad6a69b0c47eb5621f56f53307d5e0672">Normalize</a>();</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;            <span class="comment">// we can now rotate the bones in current plane as if the desired end was on the currentEnd axis</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            <span class="keywordtype">float</span> alphaDif = (float)(finalAlpha - currentAlpha);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            <span class="keywordtype">float</span> betaDif = (float)(finalBeta - currentBeta);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> firstBoneRotation = <a class="code" href="namespace_matrix.html">Matrix</a>.CreateFromAxisAngle(-currentPlaneNormal, alphaDif);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> secondBoneRotation = <a class="code" href="namespace_matrix.html">Matrix</a>.CreateFromAxisAngle(currentPlaneNormal, betaDif);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <span class="comment">// now get the angle between original and final position plane normal</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            originToCurrentEnd.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ad6a69b0c47eb5621f56f53307d5e0672">Normalize</a>();</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            originToDesiredEnd.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ad6a69b0c47eb5621f56f53307d5e0672">Normalize</a>();</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            <span class="keywordtype">double</span> dotProd = originToCurrentEnd.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a5ce7a4adfe73e681da923ac25598b00d">Dot</a>(originToDesiredEnd);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            dotProd = <a class="code" href="namespace_math_helper.html">MathHelper</a>.Clamp(dotProd, -1, 1);</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            <span class="keywordtype">double</span> delta = <a class="code" href="namespace_math.html">Math</a>.Acos(dotProd);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> planeRotationAxis = <a class="code" href="namespace_vector3.html">Vector3</a>.Cross(originToCurrentEnd, originToDesiredEnd);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            planeRotationAxis.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ad6a69b0c47eb5621f56f53307d5e0672">Normalize</a>();</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="comment">// find the rotation matrices for bones in the original plane</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> planeRotation = <a class="code" href="namespace_matrix.html">Matrix</a>.CreateFromAxisAngle(planeRotationAxis, (<span class="keywordtype">float</span>)delta);</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            <span class="comment">// compute the final rotations</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;            firstBoneRotation = planeRotation * firstBoneRotation;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            secondBoneRotation = secondBoneRotation * firstBoneRotation;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;            <span class="comment">// draw the final positions if debug enabled</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            <span class="keywordflow">if</span> (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_IKSOLVERS)</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            {</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                <a class="code" href="namespace_vector3.html">Vector3</a> rotatedFirst = <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(firstBoneVector, firstBoneRotation);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                <a class="code" href="namespace_vector3.html">Vector3</a> rotatedSecond = <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(secondBoneVector, secondBoneRotation);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + rotatedFirst, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.Purple, <a class="code" href="namespace_color.html">Color</a>.Purple, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(<a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + rotatedFirst, WorldMatrix), <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(origin + rotatedFirst + rotatedSecond, WorldMatrix), <a class="code" href="namespace_color.html">Color</a>.White, <a class="code" href="namespace_color.html">Color</a>.White, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            }</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <span class="comment">// Now we compute the final absolute transforms for the bones</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> firstBoneFinalAbsoluteTransform = firstBoneAbsoluteTransform * firstBoneRotation;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> firstBoneParentAbsoluteTransform = firstBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a>.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> localFirstBoneTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Multiply(firstBoneFinalAbsoluteTransform, <a class="code" href="namespace_matrix.html">Matrix</a>.Invert(firstBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ac54d9a735e8deaaed35b97f96ef7f405">BindTransform</a> * firstBoneParentAbsoluteTransform));</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            firstBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a94364706606a4cd5d7c3d67a4ce4b296">Rotation</a> = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(localFirstBoneTransform);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            firstBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> secondBoneFinalAbsoluteTransform = secondBoneAbsoluteTransform * secondBoneRotation;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> secondBoneParentAbsoluteTransform = secondBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">Parent</a>.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">AbsoluteTransform</a>;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            <a class="code" href="namespace_matrix.html">Matrix</a> localSecondBoneTransform = <a class="code" href="namespace_matrix.html">Matrix</a>.Multiply(secondBoneFinalAbsoluteTransform, <a class="code" href="namespace_matrix.html">Matrix</a>.Invert(secondBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ac54d9a735e8deaaed35b97f96ef7f405">BindTransform</a> * secondBoneParentAbsoluteTransform));</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            secondBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a94364706606a4cd5d7c3d67a4ce4b296">Rotation</a> = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(localSecondBoneTransform);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            secondBone.<a class="code" href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">ComputeAbsoluteTransform</a>();</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="comment">// solve the last bone </span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <span class="keywordflow">if</span> (finalBone != null &amp;&amp; finalTransform.IsValid() &amp;&amp; isDesiredEndReachable)</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            {</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                <span class="comment">//MatrixD absoluteTransformEnd = finalBone.AbsoluteTransform * finalTransform; // this is our local final transform ( rotation)</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                <span class="comment">// get the related transformation to original binding pose</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                <a class="code" href="namespace_matrix_d.html">MatrixD</a> localTransformRelated;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) localTransformRelated = finalTransform * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                <span class="keywordflow">else</span> localTransformRelated = finalTransform.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>() * <a class="code" href="namespace_matrix_d.html">MatrixD</a>.Invert((<a class="code" href="namespace_matrix_d.html">MatrixD</a>)finalBone.BindTransform * finalBone.Parent.AbsoluteTransform);</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                <span class="comment">//localTransformRelated = Matrix.Normalize(localTransformRelated);</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                <span class="comment">// from there get the rotation and translation</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                finalBone.Rotation = <a class="code" href="namespace_quaternion.html">Quaternion</a>.CreateFromRotationMatrix(<a class="code" href="namespace_matrix.html">Matrix</a>.Normalize((<a class="code" href="namespace_matrix.html">Matrix</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">GetOrientation</a>()));</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                <span class="keywordflow">if</span> (allowFinalBoneTranslation) finalBone.Translation = (<a class="code" href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a>)localTransformRelated.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">Translation</a>;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                finalBone.ComputeAbsoluteTransform();</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            }</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;            <span class="keywordflow">return</span> isDesiredEndReachable;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        }</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keyword">public</span> <span class="keyword">static</span> CastHit? GetClosestFootSupportPosition(<a class="code" href="class_v_rage_1_1_game_1_1_entity_1_1_my_entity.html">MyEntity</a> characterEntity, <a class="code" href="class_v_rage_1_1_game_1_1_entity_1_1_my_entity.html">MyEntity</a> characterTool, <a class="code" href="namespace_vector3.html">Vector3</a> from, <a class="code" href="namespace_vector3.html">Vector3</a> up, <a class="code" href="namespace_vector3.html">Vector3</a> footDimension, <a class="code" href="namespace_matrix.html">Matrix</a> WorldMatrix, <span class="keywordtype">float</span> castDownLimit, <span class="keywordtype">float</span> castUpLimit, uint raycastFilterLayer = 0)</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        {</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            <span class="keywordtype">bool</span> gotHit = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            CastHit hit = <span class="keyword">new</span> CastHit();</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            <a class="code" href="namespace_matrix_d.html">MatrixD</a> matrix = WorldMatrix;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> footTranslationFromAnkle = <a class="code" href="namespace_vector3.html">Vector3</a>.Zero;<span class="comment">//new Vector3(0, footDimension.Y, - footDimension.Y + footDimension.X);    // assunming the -Z is facing front</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <span class="comment">// set the proper translation</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            matrix.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">Translation</a> = <a class="code" href="namespace_vector3.html">Vector3</a>.Zero; <span class="comment">// just keep the matrix&#39;s orientation etc.</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            footTranslationFromAnkle = <a class="code" href="namespace_vector3.html">Vector3</a>.Transform(footTranslationFromAnkle, matrix); <span class="comment">// get it to the world</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            matrix.<a class="code" href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">Translation</a> = from + up * castUpLimit + footTranslationFromAnkle; <span class="comment">// set the matrix translation to position from where we cast - we need to shift from the ankle</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            <span class="comment">// our shape cast returned data structure</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            <span class="comment">//HkContactPointData? cpd = null;</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment"></span>            <span class="comment">//HkShape shape = new HkBoxShape(footDimension * 0.5f);</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> capsA = <span class="keyword">new</span> <a class="code" href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a>(0, footDimension.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ab3e1bb2d2d351b58864f23f3a87f7aaf">Y</a> / 2, 0);</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> capsB = <span class="keyword">new</span> <a class="code" href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a>(0, footDimension.<a class="code" href="struct_v_rage_math_1_1_vector3.html#ab3e1bb2d2d351b58864f23f3a87f7aaf">Y</a> / 2, -footDimension.<a class="code" href="struct_v_rage_math_1_1_vector3.html#a7973ae211be4c69693212a02b97636aa">Z</a>);</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            <span class="comment">//capsA = Vector3.Transform(capsA, WorldMatrix.GetOrientation());</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;            <span class="comment">//capsB = Vector3.Transform(capsB, WorldMatrix.GetOrientation());</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            <span class="comment">//HkShape shape = new HkCapsuleShape(capsA, capsB, footDimension.X / 2);</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> castFrom = from + up * castUpLimit;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            <a class="code" href="namespace_vector3.html">Vector3</a> castTo = from - up * castDownLimit;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            <span class="comment">//cpd = MyPhysics.CastShapeReturnContactData(castTo + footTranslationFromAnkle, shape, ref matrix, Physics.CharacterProxy.CharacterCollisionFilter, 0.0f);            </span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;           </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;            <span class="comment">//var hit = MyPhysics.CastRay(castFrom, castTo, out position, out normal, Physics.CharacterProxy.CharacterCollisionFilter, true); </span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;            <span class="comment">//LineD castLine = new LineD(castFrom, castTo);</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;            <span class="comment">//var result = MyEntities.GetIntersectionWithLine(ref castLine, characterEntity, characterTool, true, false, true);</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;            <span class="comment">//if (result != null)</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            <span class="comment">//{</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;            <span class="comment">//    hit.Position = result.Value.IntersectionPointInWorldSpace;</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <span class="comment">//    hit.Normal = result.Value.NormalInWorldSpace;</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;            <span class="comment">//    gotHit = true;</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            <span class="comment">//    if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawSphere(hit.Position, 0.02f, Color.Gray, 1, false);</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawText3D(hit.Position, &quot;Entity Intersection hit&quot;, Color.Gray, 1, false);</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            <span class="keywordflow">if</span> (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTLINE)</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            {</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawText3D(castFrom + footTranslationFromAnkle, <span class="stringliteral">&quot;Cast line&quot;</span>, <a class="code" href="namespace_color.html">Color</a>.White, 1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(castFrom + footTranslationFromAnkle, castTo + footTranslationFromAnkle, <a class="code" href="namespace_color.html">Color</a>.White, <a class="code" href="namespace_color.html">Color</a>.White, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            }</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            <span class="keywordflow">if</span> (MyFakes.ENABLE_FOOT_IK_USE_HAVOK_RAYCAST)</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            {</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                <span class="comment">// do the ray cast also, because ground may not be flat and we will use this to correct values just using raycast, this takes in consideration convex shape radius and ignores it</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                <a class="code" href="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics.html">MyPhysics</a>.<a class="code" href="struct_sandbox_1_1_engine_1_1_physics_1_1_my_physics_1_1_hit_info.html">HitInfo</a> hitInfo;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                 <span class="keywordflow">if</span> (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTLINE)</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                 {</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                     <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawText3D(castFrom, <span class="stringliteral">&quot;Raycast line&quot;</span>, <a class="code" href="namespace_color.html">Color</a>.Green, 1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                     <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawLine3D(castFrom, castTo, <a class="code" href="namespace_color.html">Color</a>.Green, <a class="code" href="namespace_color.html">Color</a>.Green, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                 }</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                </div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                 <span class="keywordflow">if</span> (<a class="code" href="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics.html">MyPhysics</a>.<a class="code" href="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics.html#a82b04add6fb303243a4f271e23cbc716">CastRay</a>(castFrom, castTo, out hitInfo, raycastFilterLayer, <span class="keyword">true</span>))</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                 {</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                     gotHit = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                     <span class="keywordflow">if</span> (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                     {</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                         <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawSphere(hitInfo.Position, 0.02f, <a class="code" href="namespace_color.html">Color</a>.Green, 1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                         <a class="code" href="namespace_v_rage_render.html">VRageRender</a>.<a class="code" href="class_v_rage_render_1_1_my_render_proxy.html">MyRenderProxy</a>.DebugDrawText3D(hitInfo.Position, <span class="stringliteral">&quot;RayCast hit&quot;</span>, <a class="code" href="namespace_color.html">Color</a>.Green, 1, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                     }</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                     <span class="comment">// this is hack, if RayCast returns a hit above the graphics cast, take this one</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                     <span class="keywordflow">if</span> (<a class="code" href="namespace_vector3.html">Vector3</a>.Dot(hitInfo.Position, up) &gt; <a class="code" href="namespace_vector3.html">Vector3</a>.Dot(hit.Position, up))</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                     {</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                         hit.Position = hitInfo.Position;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                         hit.Normal = hitInfo.HkHitInfo.Normal;                         </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                     }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                 }</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            }</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                </div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;            <span class="comment">//    // now we need to recalculate the hit position to center</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            <span class="comment">//    cp.HitPosition = from - Vector3.Dot(WorldMatrix.Translation - cp.HitPosition, up) * up;</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;            <span class="comment">//    //cp.HitPosition.Interpolate3(castFrom, castTo, cp.DistanceFraction);</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;            <span class="comment">//    //cp.HitPosition -= footTranslationFromAnkle;</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            <span class="comment">//    if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawSphere(cp.HitPosition, 0.03f, Color.Violet, 1, false);</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawText3D(cp.HitPosition, &quot;ShapeCast hit Centered&quot;, Color.Violet, 1, false);</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            <span class="comment">//    // shape cast correction using the normal</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="comment">//    //float dotProductAbs = WorldMatrix.Forward.Dot(cp.Normal);</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            <span class="comment">//    //cp.HitPosition -= WorldMatrix.Up * (1 - dotProductAbs) * footDimension.Y;</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            <span class="comment">//    // draw shape and ray cast hits</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            <span class="comment">//    if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            <span class="comment">//        matrix.Translation = cp.HitPosition;</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawOBB(Matrix.CreateScale(footDimension) * matrix, Color.White, 1, false, false);</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawCapsule(Vector3.Transform(capsA, WorldMatrix.GetOrientation()) + cp.HitPosition, Vector3.Transform(capsB, WorldMatrix.GetOrientation()) + cp.HitPosition, footDimension.X, Color.Red, false);</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;            <span class="comment">//    // use raycast to correct position</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            <span class="comment">//    //if (hit)</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            <span class="comment">//    //{</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;            <span class="comment">//    //    // draw shape and ray cast hits</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            <span class="comment">//    //    if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;            <span class="comment">//    //    {</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            <span class="comment">//    //        VRageRender.MyRenderProxy.DebugDrawSphere(position, 0.02f, Color.Green, 1, false, false);</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            <span class="comment">//    //        VRageRender.MyRenderProxy.DebugDrawText3D(position, &quot;RayCast hit&quot;, Color.Green, 1, false);</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;            <span class="comment">//    //    }</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;            <span class="comment">//    //    // shift the foot  up for the ankle height according to the normal orientation</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            <span class="comment">//    //    //float dotProductAbs = Math.Abs( WorldMatrix.Forward.Dot(normal));                    </span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            <span class="comment">//    //    //{</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            <span class="comment">//    //    //    // get the difference between shape and ray cast and set the position</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;            <span class="comment">//    //    //    Vector3 difference = (position - cp.HitPosition) * (dotProductAbs);</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            <span class="comment">//    //    //    cp.HitPosition = position - difference; // prefer shapecast when the ground is on ankle</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            <span class="comment">//    //    //}</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            <span class="comment">//    //    cp.HitPosition.Interpolate3(cp.HitPosition, position, Vector3.Dot(WorldMatrix.Up, normal));</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            <span class="comment">//    //    //cp.Normal = normal;</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            <span class="comment">//    //}</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;              </div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;            <span class="comment">//    // where will be final foot if not ankle&#39;s shifted</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;            <span class="comment">//    if (MyDebugDrawSettings.ENABLE_DEBUG_DRAW &amp;&amp; MyDebugDrawSettings.DEBUG_DRAW_CHARACTER_IK_RAYCASTHITS)</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            <span class="comment">//    {</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            <span class="comment">//        matrix.Translation = cp.HitPosition;</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawSphere(cp.HitPosition, 0.02f, Color.Red, 1, false, false);</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawText3D(cp.HitPosition, &quot;Final hit&quot;, Color.Red, 1, false);</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawLine3D(cp.HitPosition, cp.HitPosition + cp.Normal, Color.YellowGreen, Color.YellowGreen, false);</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;            <span class="comment">//        VRageRender.MyRenderProxy.DebugDrawOBB(Matrix.CreateScale(footDimension) * matrix, Color.Cyan, 1, false, false);</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;            <span class="comment">//    }</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            <span class="comment">//}</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;            <span class="keywordflow">return</span> gotHit ? <span class="keyword">new</span> CastHit?(hit) : null;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        }</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    }</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;}</div>
<div class="ttc" id="namespace_system_1_1_text_html"><div class="ttname"><a href="namespace_system_1_1_text.html">System.Text</a></div><div class="ttdef"><b>Definition:</b> <a href="_sandbox_8_graphics_2_string_builder_extensions_8cs_source.html#l00008">StringBuilderExtensions.cs:8</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_game_html"><div class="ttname"><a href="namespace_sandbox_1_1_game.html">Sandbox.Game</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_game_1_1_entities_1_1_character_html"><div class="ttname"><a href="namespace_sandbox_1_1_game_1_1_entities_1_1_character.html">Sandbox.Game.Entities.Character</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_character_component_8cs_source.html#l00051">MyCharacterComponent.cs:51</a></div></div>
<div class="ttc" id="namespace_system_1_1_linq_html"><div class="ttname"><a href="namespace_system_1_1_linq.html">System.Linq</a></div></div>
<div class="ttc" id="namespace_system_1_1_collections_1_1_generic_html"><div class="ttname"><a href="namespace_system_1_1_collections_1_1_generic.html">System.Collections.Generic</a></div><div class="ttdef"><b>Definition:</b> <a href="_dictionary_extensions_8cs_source.html#l00007">DictionaryExtensions.cs:7</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_ad6a69b0c47eb5621f56f53307d5e0672"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#ad6a69b0c47eb5621f56f53307d5e0672">VRageMath.Vector3.Normalize</a></div><div class="ttdeci">float Normalize()</div><div class="ttdoc">Turns the current vector into a unit vector. The result is a vector one unit in length pointing in th...</div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00591">Vector3.cs:591</a></div></div>
<div class="ttc" id="namespace_math_helper_html"><div class="ttname"><a href="namespace_math_helper.html">MathHelper</a></div></div>
<div class="ttc" id="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit_html"><div class="ttname"><a href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html">Sandbox.Game.Entities.Character.MyInverseKinematics.CastHit</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_inverse_kinematics_8cs_source.html#l00023">MyInverseKinematics.cs:23</a></div></div>
<div class="ttc" id="namespace_entities_html"><div class="ttname"><a href="namespace_entities.html">Entities</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_engine_html"><div class="ttname"><a href="namespace_sandbox_1_1_engine.html">Sandbox.Engine</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html_a94364706606a4cd5d7c3d67a4ce4b296"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a94364706606a4cd5d7c3d67a4ce4b296">VRageRender.Animations.MyCharacterBone.Rotation</a></div><div class="ttdeci">Quaternion Rotation</div><div class="ttdoc">Bone rotation </div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00088">MyCharacterBone.cs:88</a></div></div>
<div class="ttc" id="namespace_v_rage_1_1_game_html_ae840d3864e36153d6f5013c7a0403dcf"><div class="ttname"><a href="namespace_v_rage_1_1_game.html#ae840d3864e36153d6f5013c7a0403dcf">VRage.Game.Game</a></div><div class="ttdeci">Game</div><div class="ttdef"><b>Definition:</b> <a href="_game_relation_attribute_8cs_source.html#l00005">GameRelationAttribute.cs:5</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_engine_1_1_physics_html"><div class="ttname"><a href="namespace_sandbox_1_1_engine_1_1_physics.html">Sandbox.Engine.Physics</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_breakable_shape_clone_job_8cs_source.html#l00011">MyBreakableShapeCloneJob.cs:11</a></div></div>
<div class="ttc" id="namespace_quaternion_html"><div class="ttname"><a href="namespace_quaternion.html">Quaternion</a></div></div>
<div class="ttc" id="namespace_system_html"><div class="ttname"><a href="namespace_system.html">System</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_my_render_proxy_html"><div class="ttname"><a href="class_v_rage_render_1_1_my_render_proxy.html">VRageRender.MyRenderProxy</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_render_proxy_8cs_source.html#l00035">MyRenderProxy.cs:35</a></div></div>
<div class="ttc" id="class_v_rage_1_1_game_1_1_entity_1_1_my_entity_html"><div class="ttname"><a href="class_v_rage_1_1_game_1_1_entity_1_1_my_entity.html">VRage.Game.Entity.MyEntity</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_entity_8cs_source.html#l00027">MyEntity.cs:27</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html_a4c094b609aba91875432a1e82a01b00e"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#a4c094b609aba91875432a1e82a01b00e">VRageRender.Animations.MyCharacterBone.Parent</a></div><div class="ttdeci">MyCharacterBone Parent</div><div class="ttdoc">The parent bone or null for the root bone </div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00098">MyCharacterBone.cs:98</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_a7973ae211be4c69693212a02b97636aa"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#a7973ae211be4c69693212a02b97636aa">VRageMath.Vector3.Z</a></div><div class="ttdeci">float Z</div><div class="ttdoc">Gets or sets the z-component of the vector. </div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00059">Vector3.cs:59</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html_ac54d9a735e8deaaed35b97f96ef7f405"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ac54d9a735e8deaaed35b97f96ef7f405">VRageRender.Animations.MyCharacterBone.BindTransform</a></div><div class="ttdeci">Matrix BindTransform</div><div class="ttdoc">The bone bind transform </div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00077">MyCharacterBone.cs:77</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_d_html_a3bcd8fcad5040b7e34f1ef56d5aa7f56"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3_d.html#a3bcd8fcad5040b7e34f1ef56d5aa7f56">VRageMath.Vector3D.Cross</a></div><div class="ttdeci">Vector3D Cross(Vector3D v)</div><div class="ttdef"><b>Definition:</b> <a href="_vector3_d_8cs_source.html#l00798">Vector3D.cs:798</a></div></div>
<div class="ttc" id="struct_sandbox_1_1_engine_1_1_physics_1_1_my_physics_1_1_hit_info_html"><div class="ttname"><a href="struct_sandbox_1_1_engine_1_1_physics_1_1_my_physics_1_1_hit_info.html">Sandbox.Engine.Physics.MyPhysics.HitInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_physics_8cs_source.html#l00049">MyPhysics.cs:49</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html">VRageRender.Animations.MyCharacterBone</a></div><div class="ttdoc">Bones in this model are represented by this class, which allows a bone to have more detail associatd ...</div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00025">MyCharacterBone.cs:25</a></div></div>
<div class="ttc" id="_my_gui_skin_definition_8cs_html_a81a223a02c34d82b47199f08308847f2"><div class="ttname"><a href="_my_gui_skin_definition_8cs.html#a81a223a02c34d82b47199f08308847f2">System</a></div><div class="ttdeci">using System</div><div class="ttdef"><b>Definition:</b> <a href="_my_gui_skin_definition_8cs_source.html#l00001">MyGuiSkinDefinition.cs:1</a></div></div>
<div class="ttc" id="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics_html"><div class="ttname"><a href="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics.html">Sandbox.Engine.Physics.MyPhysics</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_physics_8cs_source.html#l00047">MyPhysics.cs:47</a></div></div>
<div class="ttc" id="namespace_color_html"><div class="ttname"><a href="namespace_color.html">Color</a></div></div>
<div class="ttc" id="namespace_vector3_d_html"><div class="ttname"><a href="namespace_vector3_d.html">Vector3D</a></div></div>
<div class="ttc" id="namespace_v_rage_1_1_utils_html"><div class="ttname"><a href="namespace_v_rage_1_1_utils.html">VRage.Utils</a></div><div class="ttdef"><b>Definition:</b> <a href="_my5_bit_encoding_8cs_source.html#l00006">My5BitEncoding.cs:6</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_matrix_d_html_a3f7696af124a3422b422c2d8a8fd3f7e"><div class="ttname"><a href="struct_v_rage_math_1_1_matrix_d.html#a3f7696af124a3422b422c2d8a8fd3f7e">VRageMath.MatrixD.GetOrientation</a></div><div class="ttdeci">MatrixD GetOrientation()</div><div class="ttdoc">Gets the orientation. </div><div class="ttdef"><b>Definition:</b> <a href="_matrix_d_8cs_source.html#l03347">MatrixD.cs:3347</a></div></div>
<div class="ttc" id="namespace_v_rage_1_1_game_html"><div class="ttname"><a href="namespace_v_rage_1_1_game.html">VRage.Game</a></div></div>
<div class="ttc" id="_my_camera_8cs_html_afeb956ae9f85b0c1c7f8d5ce4a07b8e5"><div class="ttname"><a href="_my_camera_8cs.html#afeb956ae9f85b0c1c7f8d5ce4a07b8e5">Vector3D</a></div><div class="ttdeci">VRageMath.Vector3D Vector3D</div><div class="ttdef"><b>Definition:</b> <a href="_my_camera_8cs_source.html#l00008">MyCamera.cs:8</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_d_html_a3b0d757665dc587b630b4cc982e25f2b"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3_d.html#a3b0d757665dc587b630b4cc982e25f2b">VRageMath.Vector3D.Normalize</a></div><div class="ttdeci">double Normalize()</div><div class="ttdoc">Turns the current vector into a unit vector. The result is a vector one unit in length pointing in th...</div><div class="ttdef"><b>Definition:</b> <a href="_vector3_d_8cs_source.html#l00807">Vector3D.cs:807</a></div></div>
<div class="ttc" id="namespace_havok_html"><div class="ttname"><a href="namespace_havok.html">Havok</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_physics_mesh_8cs_source.html#l00007">IPhysicsMesh.cs:7</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_d_html_aef09c09066721606efaca69aabbfeeb8"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3_d.html#aef09c09066721606efaca69aabbfeeb8">VRageMath.Vector3D.Dot</a></div><div class="ttdeci">static double Dot(Vector3D vector1, Vector3D vector2)</div><div class="ttdoc">Calculates the dot product of two vectors. If the two vectors are unit vectors, the dot product retur...</div><div class="ttdef"><b>Definition:</b> <a href="_vector3_d_8cs_source.html#l00756">Vector3D.cs:756</a></div></div>
<div class="ttc" id="namespace_math_html"><div class="ttname"><a href="namespace_math.html">Math</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_a4d44c319212bffba8239f9b1e96f9730"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#a4d44c319212bffba8239f9b1e96f9730">VRageMath.Vector3.Length</a></div><div class="ttdeci">float Length()</div><div class="ttdoc">Calculates the length of the vector. </div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00472">Vector3.cs:472</a></div></div>
<div class="ttc" id="namespace_matrix_d_html"><div class="ttname"><a href="namespace_matrix_d.html">MatrixD</a></div></div>
<div class="ttc" id="namespace_v_rage_render_1_1_animations_html"><div class="ttname"><a href="namespace_v_rage_render_1_1_animations.html">VRageRender.Animations</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_animation_tree_node_8cs_source.html#l00001">MyAnimationTreeNode.cs:1</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_game_1_1_entities_html_ab6e850d9cf3c042efac58575b1459daba76a40e4f974fd895a0a2598c1cee28b4"><div class="ttname"><a href="namespace_sandbox_1_1_game_1_1_entities.html#ab6e850d9cf3c042efac58575b1459daba76a40e4f974fd895a0a2598c1cee28b4">Sandbox.Game.Entities.Character</a></div></div>
<div class="ttc" id="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics_html_a82b04add6fb303243a4f271e23cbc716"><div class="ttname"><a href="class_sandbox_1_1_engine_1_1_physics_1_1_my_physics.html#a82b04add6fb303243a4f271e23cbc716">Sandbox.Engine.Physics.MyPhysics.CastRay</a></div><div class="ttdeci">static void CastRay(Vector3D from, Vector3D to, List&lt; HitInfo &gt; toList, int raycastFilterLayer=0)</div><div class="ttdef"><b>Definition:</b> <a href="_my_physics_8cs_source.html#l00952">MyPhysics.cs:952</a></div></div>
<div class="ttc" id="namespace_v_rage_math_html"><div class="ttname"><a href="namespace_v_rage_math.html">VRageMath</a></div><div class="ttdef"><b>Definition:</b> <a href="_base27_directions_8cs_source.html#l00007">Base27Directions.cs:7</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_game_1_1_entities_html"><div class="ttname"><a href="namespace_sandbox_1_1_game_1_1_entities.html">Sandbox.Game.Entities</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_entity3_d_sound_emitter_8cs_source.html#l00018">MyEntity3DSoundEmitter.cs:18</a></div></div>
<div class="ttc" id="namespace_system_1_1_collections_html"><div class="ttname"><a href="namespace_system_1_1_collections.html">System.Collections</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html_ae6f7caea5fabc0b6ad96d598b3d12bc6"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#ae6f7caea5fabc0b6ad96d598b3d12bc6">VRageRender.Animations.MyCharacterBone.AbsoluteTransform</a></div><div class="ttdeci">Matrix AbsoluteTransform</div><div class="ttdoc">The bone absolute transform </div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00104">MyCharacterBone.cs:104</a></div></div>
<div class="ttc" id="class_v_rage_render_1_1_animations_1_1_my_character_bone_html_adbe3b2b61bbd9315814fe3e490ce2ca7"><div class="ttname"><a href="class_v_rage_render_1_1_animations_1_1_my_character_bone.html#adbe3b2b61bbd9315814fe3e490ce2ca7">VRageRender.Animations.MyCharacterBone.ComputeAbsoluteTransform</a></div><div class="ttdeci">void ComputeAbsoluteTransform(bool propagateTransformToChildren=true)</div><div class="ttdoc">Compute the absolute transformation for this bone. </div><div class="ttdef"><b>Definition:</b> <a href="_my_character_bone_8cs_source.html#l00248">MyCharacterBone.cs:248</a></div></div>
<div class="ttc" id="namespace_v_rage_render_html"><div class="ttname"><a href="namespace_v_rage_render.html">VRageRender</a></div></div>
<div class="ttc" id="namespace_sandbox_html"><div class="ttname"><a href="namespace_sandbox.html">Sandbox</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_a5ce7a4adfe73e681da923ac25598b00d"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#a5ce7a4adfe73e681da923ac25598b00d">VRageMath.Vector3.Dot</a></div><div class="ttdeci">static float Dot(Vector3 vector1, Vector3 vector2)</div><div class="ttdoc">Calculates the dot product of two vectors. If the two vectors are unit vectors, the dot product retur...</div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00558">Vector3.cs:558</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_matrix_d_html_a2cf7c06f225534ac8c1d9d7272833655"><div class="ttname"><a href="struct_v_rage_math_1_1_matrix_d.html#a2cf7c06f225534ac8c1d9d7272833655">VRageMath.MatrixD.Translation</a></div><div class="ttdeci">Vector3D Translation</div><div class="ttdoc">Gets and sets the translation vector of the Matrix. </div><div class="ttdef"><b>Definition:</b> <a href="_matrix_d_8cs_source.html#l00461">MatrixD.cs:461</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_abe3f1b18fcf85173572d6f4ef7393060"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#abe3f1b18fcf85173572d6f4ef7393060">VRageMath.Vector3.LengthSquared</a></div><div class="ttdeci">float LengthSquared()</div><div class="ttdoc">Calculates the length of the vector squared. </div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00480">Vector3.cs:480</a></div></div>
<div class="ttc" id="namespace_v_rage_html"><div class="ttname"><a href="namespace_v_rage.html">VRage</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_matrix_html_a61efb7ecb2de3857f55f91d9acf44e4a"><div class="ttname"><a href="struct_v_rage_math_1_1_matrix.html#a61efb7ecb2de3857f55f91d9acf44e4a">VRageMath.Matrix.Translation</a></div><div class="ttdeci">Vector3 Translation</div><div class="ttdoc">Gets and sets the translation vector of the Matrix. </div><div class="ttdef"><b>Definition:</b> <a href="_matrix_8cs_source.html#l00478">Matrix.cs:478</a></div></div>
<div class="ttc" id="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit_html_a12c58e10f64b6a66ba7a1a62e15045bf"><div class="ttname"><a href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a12c58e10f64b6a66ba7a1a62e15045bf">Sandbox.Game.Entities.Character.MyInverseKinematics.CastHit.Normal</a></div><div class="ttdeci">Vector3 Normal</div><div class="ttdef"><b>Definition:</b> <a href="_my_inverse_kinematics_8cs_source.html#l00026">MyInverseKinematics.cs:26</a></div></div>
<div class="ttc" id="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit_html_a060625392d2503cb24dfb5d31930c8da"><div class="ttname"><a href="struct_sandbox_1_1_game_1_1_entities_1_1_character_1_1_my_inverse_kinematics_1_1_cast_hit.html#a060625392d2503cb24dfb5d31930c8da">Sandbox.Game.Entities.Character.MyInverseKinematics.CastHit.Position</a></div><div class="ttdeci">Vector3 Position</div><div class="ttdef"><b>Definition:</b> <a href="_my_inverse_kinematics_8cs_source.html#l00025">MyInverseKinematics.cs:25</a></div></div>
<div class="ttc" id="namespace_vector3_html"><div class="ttname"><a href="namespace_vector3.html">Vector3</a></div></div>
<div class="ttc" id="namespace_matrix_html"><div class="ttname"><a href="namespace_matrix.html">Matrix</a></div></div>
<div class="ttc" id="struct_v_rage_math_1_1_vector3_html_ab3e1bb2d2d351b58864f23f3a87f7aaf"><div class="ttname"><a href="struct_v_rage_math_1_1_vector3.html#ab3e1bb2d2d351b58864f23f3a87f7aaf">VRageMath.Vector3.Y</a></div><div class="ttdeci">float Y</div><div class="ttdoc">Gets or sets the y-component of the vector. </div><div class="ttdef"><b>Definition:</b> <a href="_vector3_8cs_source.html#l00054">Vector3.cs:54</a></div></div>
<div class="ttc" id="_my_texture_atlas_utils_8cs_html_a739619d477e8e447588f40eba590b3b3"><div class="ttname"><a href="_my_texture_atlas_utils_8cs.html#a739619d477e8e447588f40eba590b3b3">Vector3</a></div><div class="ttdeci">VRageMath.Vector3 Vector3</div><div class="ttdef"><b>Definition:</b> <a href="_my_texture_atlas_utils_8cs_source.html#l00020">MyTextureAtlasUtils.cs:20</a></div></div>
<div class="ttc" id="namespace_v_rage_1_1_game_1_1_entity_html"><div class="ttname"><a href="namespace_v_rage_1_1_game_1_1_entity.html">VRage.Game.Entity</a></div><div class="ttdef"><b>Definition:</b> <a href="_debug_created_by_8cs_source.html#l00001">DebugCreatedBy.cs:1</a></div></div>
<div class="ttc" id="namespace_sandbox_1_1_engine_1_1_utils_html"><div class="ttname"><a href="namespace_sandbox_1_1_engine_1_1_utils.html">Sandbox.Engine.Utils</a></div><div class="ttdef"><b>Definition:</b> <a href="_my_battle_helper_8cs_source.html#l00014">MyBattleHelper.cs:14</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jan 23 2017 01:16:28 for Space Engineers by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
